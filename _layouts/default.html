<!doctype html>
<html lang="{{ site.lang | default: 'en' }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% if page.title %}{{ page.title }} · {% endif %}{{ site.title }}</title>
    {% seo %}
    <!-- CSS (cache-buster con build_revision) -->
    <link rel="stylesheet" href="{{ '/assets/css/style.css?v=' | append: site.github.build_revision | relative_url }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js"></script>
  </head>
  <body>
    <!-- 🔝 Topbar -->
    <header class="site-topbar">
      <div class="container topbar-flex">

        <!-- Izquierda: Logo + Marca + Tagline -->
        <div class="brand-block">
          <a href="{{ '/' | relative_url }}" class="brand">
            <img src="{{ '/assets/images/btc-logo.png' | relative_url }}" alt="BTC Logo" class="site-logo">
            <div class="brand-text">
              <span class="brand-title">{{ site.title }}</span>
              <div class="tagline">{{ site.tagline }}</div>
            </div>
          </a>
        </div>

        <!-- Derecha: Buscador + Menú (buscador va primero) -->
        <div class="topbar-right">
          <!-- Buscador -->
          <form action="{{ '/' | relative_url }}" method="get" class="search-form" role="search" aria-label="Site search">
            <input type="text" name="q" placeholder="Search articles..." class="search-input" aria-label="Search" />
          </form>

          <!-- Menú en el orden solicitado -->
          <nav class="nav" aria-label="Primary">
            <a href="{{ '/' | relative_url }}">Home</a>
            <a href="{{ '/markets/' | relative_url }}">Markets</a>
            <a href="{{ '/stories/' | relative_url }}">Stories & Cases</a>
            <a href="{{ '/archive/' | relative_url }}">Archive</a>
            <a href="{{ '/newsletter/' | relative_url }}">Newsletter</a>
            <a href="{{ '/donate/' | relative_url }}">Donate</a>
            <a href="{{ '/about/' | relative_url }}">About</a>
          </nav>
        </div>
      </div>
    </header>

    <!-- 📦 Resultados buscador -->
    <div id="search-results"
         style="display:none;background:#fff;position:absolute;top:80px;right:2rem;z-index:200;padding:1rem;border:1px solid #ddd;border-radius:6px;max-width:300px;">
    </div>

    <!-- 📈 Ticker -->
    <div class="ticker-bar tradingview-widget-container">
      <div class="tradingview-widget-container__widget"></div>
      <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
      {
        "symbols": [
          { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
          { "proName": "NASDAQ:IXIC", "title": "NASDAQ" },
          { "proName": "DJI", "title": "Dow Jones" },
          { "proName": "CME_MINI:ES1!", "title": "E-Mini S&P Futures" },
          { "proName": "OANDA:EURUSD", "title": "EUR/USD" },
          { "proName": "COMEX:GC1!", "title": "Gold" },
          { "proName": "NYMEX:CL1!", "title": "Crude Oil" },
          { "proName": "BINANCE:BTCUSDT", "title": "Bitcoin" },
          { "proName": "BINANCE:ETHUSDT", "title": "Ethereum" }
        ],
        "showSymbolLogo": true,
        "colorTheme": "dark",
        "isTransparent": false,
        "displayMode": "adaptive",
        "locale": "en"
      }
      </script>
    </div>

    <!-- 📄 Contenido -->
    <main class="container page-body">
      {{ content }}
    </main>

    <!-- 📑 Footer -->
    <footer class="container site-footer">
      <p>© {{ site.title }} {{ 'now' | date: '%Y' }}</p>
    </footer>

    <!-- 🔍 Script buscador -->
    <script>
      let idx, store;
      fetch("{{ '/search.json' | relative_url }}")
        .then(res => res.json())
        .then(data => {
          store = data;
          idx = lunr(function () {
            this.ref("url");
            this.field("title");
            this.field("excerpt");
            this.field("categories");
            data.forEach(doc => this.add(doc));
          });
        });

      document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.querySelector(".search-input");
        const resultsBox = document.getElementById("search-results");

        function hideResults() {
          resultsBox.style.display = "none";
          resultsBox.innerHTML = "";
        }

        document.addEventListener("click", (e) => {
          if (!resultsBox.contains(e.target) && e.target !== searchInput) hideResults();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") hideResults();
        });

        if (searchInput) {
          searchInput.addEventListener("input", function () {
            const query = this.value.trim();
            resultsBox.innerHTML = "";
            if (!idx || query.length < 2) { hideResults(); return; }

            const results = idx.search(query);
            if (results.length > 0) {
              resultsBox.style.display = "block";
              results.forEach(r => {
                const item = store.find(d => d.url === r.ref);
                if (item) {
                  const p = document.createElement("p");
                  p.innerHTML = `<a href="${item.url}">${item.title}</a>`;
                  resultsBox.appendChild(p);
                }
              });
            } else {
              resultsBox.style.display = "block";
              resultsBox.innerHTML = "<p>No results found</p>";
            }
          });
        }
      });
    </script>
  </body>
</html>
